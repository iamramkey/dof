<?php


// Kickstart the framework
$f3 = require('lib/base.php');


if(!is_dir('XMLFiles')){
	mkdir('XMLFiles');
}
$f3->set('DEBUG', 1);
if ((float)PCRE_VERSION < 7.9)
	trigger_error('PCRE version is out of date');
set_time_limit(0);
// Load configuration
$f3->config('config.ini');
$f3->set('DEBUG',0);


$development = false;

if($development){
	date_default_timezone_set ('Asia/Calcutta');
}else{
	date_default_timezone_set ('Asia/Muscat');
}

/*
	this is the malware table name
*/
$tableName = 'arc_trend_cc55xm';

/*
	this is the malware bulk table name
*/
$bulkTableName = 'malware_bulk';

/*
	this is the malware table column
*/
$column = 'Host_Address';
/**
 * Merge two arrays - but if one is blank or not an array, return the other.
 * @param $a array First array, into which the second array will be merged
 * @param $b array Second array, with the data to be merged
 * @param $unique boolean If true, remove duplicate values before returning
 */
function arrayMerge($a, $b, $unique = false) {
	if (empty($b)) {
		return;  // No changes to be made to $a
	}
	if (empty($a)) {
		$a = $b;
		return;
	}
	$a = array_merge($a, $b);
	if ($unique) {
		$a = array_unique($a);
	}
	return $a;
}
function outerDb(){
	global $development;
	if($development){
		/*
			rama krishna's local system main database server details
		*/
		$host = 'localhost';
		$port = '3306';
		$database = 'arcsight';
		$username = 'root';
		$password = '';
	}else{
		/*
			main database server details
		*/
		$host = '172.25.20.40';
		$port = '3306';
		$database = 'arcsight';
		$username = 'dashboard';
		$password = 'dof1234';
	}
	return new DB\SQL(
		'mysql:host=' . $host . ';port=' . $port . ';dbname=' . $database,
		$username,
		$password
	);
}
function ipDb(){
	/*
	local system main database server details
	list of tables available in this db is 
	d ->hpsm_tickets
	d->location
	soc_ipct->ip2location
	*/
	$host = 'localhost';
	$port = '3306';
	$database = 'soc_ipct';
	$username = 'root';
	$password = '';
	return new DB\SQL(
		'mysql:host=' . $host . ';port=' . $port . ';dbname=' . $database,
		$username,
		$password
	);
}
$time_start = microtime(true);
echo "Execution started";
set_time_limit(0);
ini_set("memory_limit",-1);
ini_set('mysql.connect_timeout', 6000);
ini_set('default_socket_timeout', 6000);
$db = outerDb();
$db1 = ipDb();

$f3->set('ONERROR', function($f3) {
	// custom error handler code goes here
	// use this if you want to display errors in a
	// format consistent with your site's theme


	$elog = new Log( 'logs/' . date('Y-m-d_H-i-s') . '_error.log');
	$elog->write(" ********* An error occurred **************");
	$elog->write($f3->get('ERROR.code'));
	$elog->write($f3->get('ERROR.status'));
	$elog->write($f3->get('ERROR.text'));
	$elog->write($f3->get('ERROR.trace'));
	$elog->write($f3->get('ERROR'));
}
		);

$elog = new Log( 'logs/' . date('Y-m-d_H-i-s') . '_malware_bulk_info.log');
$truncated = $db1->exec("truncate table $bulkTableName");
if(empty($truncated)){
	$elog->write("truncated $bulkTableName successfully");
}else{
	$elog->write("truncate failed on table name : $bulkTableName");
	$elog->write("Reason is ");
	$elog->write($db1->log());
	exit();
}
$elog->write("reading $tableName data in outerDb");
$result = $db->exec("select * from $tableName");
$elog->write("$tableName is having " . count($result) . " rows");
$insertArr = [];
if(count($result) > 0){
	$singleFile = 'XMLFiles/MalwareReports_Bulk.xml';
	$single = new XMLWriter();
	$single->openMemory();
	$single->setIndent(true);
	$single->startDocument();
	$single->startElement("DocumentElement");
	foreach($result as $x) {
		$query = "select * from vlans where '" . $x[$column] . "' <= END_IP_dEC and '" . $x[$column] . "' >= START_IP_dEC";
		$res = $db1->exec($query);
		if(!empty($res)){
			$finalResult = arrayMerge($x,$res[0]);
			$insertSQL = "INSERT INTO `$bulkTableName` SET ";
			foreach ($finalResult as $field => $value) {
				if($field == 'id'){
					continue;						
				}
				if($field == 'ID'){
					continue;						
				}
				$insertSQL .= " `" . $field . "` = '" . addslashes($value) . "', ";
			}
			$insertSQL = trim($insertSQL, ", ");
			$elog->write("query is");
			$elog->write("$insertSQL");
			$insertArr[] = $insertSQL;
			addXMLElement($single,$finalResult);
		}
	}
	$insertRes = $db1->exec($insertArr);
	if($insertRes){
		$elog->write("Insert on  $tableName is successfull");		
	}else{
		$elog->write("Insert on $tableName is failed");
		$elog->write("Reason is ");
		$elog->write($db1->log());
	}
	$single->endElement();
	if(file_put_contents($singleFile,$single->outputMemory()) !== false){
		$elog->write("Successfully written all records to bulk xml file");
	}else{
		$elog->write("there was an error writing data to bulk xml file");
	}
}

$f3->route('GET /NoNeXiStInGrOuTe',function($f3){

});

$time_end = microtime(true);

//dividing with 60 will give the execution time in minutes other wise seconds
$execution_time = ($time_end - $time_start);
$elog->write('Total Execution Time: '.$execution_time.' Seconds');
echo '<br><b>Total Execution Time:</b> '.$execution_time.' Seconds';


function addXMLElement($single,$data){
	$single->startElement("MalwareReports");
	$single->writeElement("LOCATION", $data['LOCATION']);
	$single->writeElement("Timestamp", date('Y-m-dTH:i:sP',strtotime($data['timeStamp'])));
	$single->writeElement("Hostname",$data['Infected_Host_Name']);
	$single->writeElement("IPAddress", long2ip($data['Host_Address']));
	$single->writeElement("Virusname", $data['Virus_Name']);
	$single->writeElement("Action", $data['deviceAction']);
	$single->writeElement("VLAN_NAME", $data['VLAN_NAME']);
	$single->writeElement("VLAN_ID", $data['VLAN_ID']);
	$single->endElement();
}

//$f3->run();


?>